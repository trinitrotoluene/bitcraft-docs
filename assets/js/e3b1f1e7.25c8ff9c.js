"use strict";(globalThis.webpackChunk_bitcraft_docs_website=globalThis.webpackChunk_bitcraft_docs_website||[]).push([[76587],{36493(e,n,t){t.d(n,{R:()=>r,x:()=>c});var o=t(82128);const i={},s=o.createContext(i);function r(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(s.Provider,{value:n},e.children)}},66204(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"concepts/querying-data","title":"Querying data","description":"Global vs Region modules","source":"@site/docs/concepts/querying-data.md","sourceDirName":"concepts","slug":"/concepts/querying-data","permalink":"/docs/concepts/querying-data","draft":false,"unlisted":false,"editUrl":"https://github.com/trinitrotoluene/bitcraft-docs/tree/master/website/docs/concepts/querying-data.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Authentication","permalink":"/docs/concepts/authentication"},"next":{"title":"Reducers","permalink":"/docs/concepts/reducers"}}');var i=t(77900),s=t(36493);const r={sidebar_position:3},c="Querying data",a={},l=[{value:"Global vs Region modules",id:"global-vs-region-modules",level:2},{value:"Creating subscriptions",id:"creating-subscriptions",level:2},{value:"Consuming changes",id:"consuming-changes",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"querying-data",children:"Querying data"})}),"\n",(0,i.jsx)(n.h2,{id:"global-vs-region-modules",children:"Global vs Region modules"}),"\n",(0,i.jsx)(n.p,{children:"Bitcraft's backend has the following modules"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"bitcraft-global"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"bitcraft-1"})," ... through to ",(0,i.jsx)(n.code,{children:"bitcraft-9"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"global"})," module holds some limited information needed across regions like some empire-related tables, player chat tab config, etc."]}),"\n",(0,i.jsxs)(n.p,{children:["Other information sits in ",(0,i.jsx)(n.code,{children:"region"})," modules - these correspond to ingame regions, so R1 is the module ",(0,i.jsx)(n.code,{children:"bitcraft-1"}),". These all share the same schema and generally contain more relevant information for developers."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"You'll notice that the global module schema docs on this site also include a bunch of tables present in the region tables, but you can generally disregard these as the region tables are the ones actually in use."})}),"\n",(0,i.jsx)(n.h2,{id:"creating-subscriptions",children:"Creating subscriptions"}),"\n",(0,i.jsxs)(n.p,{children:["You declare a subscription in the SDK using an SQL-like language. It doesn't support many of the features you might expect from SQL so it's worth checking the ",(0,i.jsx)(n.a,{href:"https://spacetimedb.com/docs/sql/",children:"SQL reference"})," in the official documentation before trying to do something clever."]}),"\n",(0,i.jsx)(n.p,{children:"I'll be using the JS client in any code examples as it produces the smallest code snippets - at its simplest a subscription can be something like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'DbConnection.builder()\n      .withUri(...)\n      .withModuleName(...)\n      .withToken(...)\n      .onConnect(onConnect)\n      .build();\n\n// build() does not block, so it\'s your responsibility to keep the program running.\n// in the C#/Rust SDKs there is the additional requirement of calling frame_tick in\n// regular intervals so the SDK can perform network I/O.\n\nasync function onConnect(conn: DbConnection, identity: Identity) {\n  await subscribe(conn, ["SELECT * FROM empire_state"])\n  console.log([...conn.db.empireState.iter()])\n}\n\n// Helper function to wrap the callback-based API into a promise\nfunction subscribe(conn: DbConnection, query: string[]) {\n  return new Promise((resolve, reject) => {\n    const subscription = conn\n      .subscriptionBuilder()\n      .onApplied(() => {\n        console.log("Subscription active");\n        resolve({\n          unsubscribe: () => {\n            if (subscription.isActive()) {\n              subscription.unsubscribe();\n            }\n          },\n        });\n      })\n      .onError((ctx) => {\n        console.log("Subscription errored");\n        reject(ctx);\n      })\n      .subscribe(query);\n  });\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"However, you don't always want to subscribe to the entire table - remember that any subscription you retain will result in SpacetimeDB attempting to keep your local state in sync with the backend."}),"\n",(0,i.jsxs)(n.p,{children:["This means that if you try to subscribe to the entire ",(0,i.jsx)(n.code,{children:"location_state"})," table, not only will you download the location of every entity in the region, but you'll get an update event for ",(0,i.jsx)(n.em,{children:"every"})," movement as well since that results in a change to this table."]}),"\n",(0,i.jsxs)(n.p,{children:["That's where query filters come in. You can do simple filters on rows like \"only give me the data for the claim with ID ",(0,i.jsx)(n.code,{children:"abc123"}),'"']}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT t.* FROM claim_state t WHERE t.entity_id = 123456789\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Or you can get creative and start ",(0,i.jsx)(n.code,{children:"JOIN"}),"ing across tables to for example only retrieve public crafts on a particular building, or the locations of buildings belonging to a particular claim, etc."]}),"\n",(0,i.jsx)(n.h2,{id:"consuming-changes",children:"Consuming changes"}),"\n",(0,i.jsx)(n.p,{children:"As you will have seen from previous snippets, the SDKs are callback driven - this means you register functions to handle events which are then called once you have a subscription that results in those events being fed to you."}),"\n",(0,i.jsx)(n.p,{children:"Picking up where we left off after subscribing to empire_state, let's say we wanted to monitor that table for changes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'async function onConnect(conn: DbConnection, identity: Identity) {\n  await subscribe(conn, ["SELECT * FROM empire_state"]);\n  console.log([...conn.db.empireState.iter()]);\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The SDK exposes ",(0,i.jsx)(n.code,{children:"onInsert"}),", ",(0,i.jsx)(n.code,{children:"onUpdate"})," and ",(0,i.jsx)(n.code,{children:"onDelete"})," events for each table. You will only receive these events for rows that are visible to your current set of subscriptions."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'async function onConnect(conn: DbConnection, identity: Identity) {\n  await subscribe(conn, ["SELECT * FROM empire_state"]);\n  console.log("initial state", [...conn.db.empireState.iter()]);\n\n  conn.db.empireState.onInsert((ctx, row) => console.log("insert", row));\n  conn.db.empireState.onUpdate((ctx, oldRow, newRow) =>\n    console.log("update", oldRow, newRow),\n  );\n  conn.db.empireState.onDelete((ctx, row) => console.log("delete", row));\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Once you've reached this point, congratulations! Now the real fun begins - learning how various tables available to you relate to in-game concepts, improving the resilience of your connection, running connections to multiple regions - the list is ever growing ",":D"]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["If you'd like to start contributing to the documentation, a good place to start is ",(0,i.jsx)(n.a,{href:"/docs/know-your-tables",children:"Know your tables"})," \ud83d\ude01"]})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);